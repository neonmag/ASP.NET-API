stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""

build-docker:
  stage: build
  image: docker:stable
  only:
    - main
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab+deploy-token-1 -p "${ACCESS_TOKEN}" registry.brist.loc
  script:
    - docker build -t "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}" --build-arg branch="${CI_COMMIT_REF_NAME}" .
    - docker push "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}"

deploy:
  stage: deploy
  image: alpine:latest
  only:
    - main
  before_script:
    - apk add --no-cache openssh
    - mkdir -p ~/.ssh
    - echo "${ID_RSA}" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H 172.16.10.22 >> ~/.ssh/known_hosts
  script:
    - ssh -i ~/.ssh/id_rsa dev@172.16.10.22 "docker pull ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME} && docker run -d --name my-container ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}"
