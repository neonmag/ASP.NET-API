stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""

build-docker:
  stage: build
  image: docker:stable
  only:
    - main
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab+deploy-token-1 -p "${ACCESS_TOKEN}" registry.brist.loc
  script:
    - docker build -t "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}" --build-arg branch="${CI_COMMIT_REF_NAME}" .
    - docker push "${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_NAME}"

deploy:
  stage: deploy
  image: alpine:latest
  only:
    - main
  before_script:
    - apk add --no-cache openssh
    - mkdir -p ~/.ssh
    - echo "$ID_RSA_B64" | base64 -d > ~/.ssh/id_rsa # Decode and save the private key to a file
    - chmod 600 ~/.ssh/id_rsa # Set the correct permissions for the private key
    - eval $(ssh-agent -s) # Start the SSH agent
    - ssh-add ~/.ssh/id_rsa # Add the private key to the SSH agent
    - ssh-keyscan -H 172.16.10.22 >> ~/.ssh/known_hosts # Add the host to known_hosts
  script:
    - ssh dev@172.16.10.22 "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY && docker pull $TAG_COMMIT && docker container rm -f my-app || true && docker run -d -p 80:80 -p 3000:3000 --name my-app $TAG_COMMIT"



